<!doctype html>
<html>
<head>
<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>

<script src="../lib/math.js"></script>
<script src="../lib/img.js"></script>
<style>
html, body { height: 100%; }

.images {
	position: relative; 
}

img {
	border: 1px solid #ddd;
}

canvas {
	position: absolute;
	left: 0;
	top: 0;
	border: 1px solid green;
	display: none;
}
.wbars {
	position: relative;
}
.wbar {
	background-color: black;
	color: gray;
	font-size: 200%;
	font-family: monospace;
	padding: 4px;
	position: relative;
	width: 1px;
	margin-left: 50%;
	overflow: visible;
	white-space: nowrap;
}
#status {
	margin-left: 50%;
	font-size: 150%;
}
</style>
<body>
	Learning rates:
	w0: <input id="rate0" value="0.2">
	w1: <input id="rate1" value="0.0001">
	w2: <input id="rate2" value="0.0001">

	Milliseconds between draws: <input id="timeout_ms" value="10">
	<hr>

	<div class="images">
		<canvas></canvas>
		<img src="test01.bmp" crossorigin="">
		<img src="test02.bmp" crossorigin="">
		<img src="test03.bmp" crossorigin="">
		<img src="test04.bmp" crossorigin="">
		<img src="test05.bmp" crossorigin="">
		<img src="test06.bmp" crossorigin="">
	</div>

	<div id="status">
		Total iteratii: <b id="iter_tot">n/a</b>.
		Total ajustari: <b id="errs_tot">n/a</b>.
		<br>Iteratia curenta: <b id="iter_crt">n/a</b>.
		Ajustarea curenta: <b id="err_crt">n/a</b>.
		<button onclick="stopShow()">Stop</button>
	</div>

	<div class="wbars">
		<div class="wbar" id="w0"></div>
		<div class="wbar" id="w1"></div>
		<div class="wbar" id="w2"></div>
	</div>
</body>
<script>

$('img').click(event => {
	img.select(event.target);

	proceseaza_imagine();
});

$('canvas').click(proceseaza_imagine);

function proceseaza_imagine() {
	var X = []; // instante-trasaturi
	var Y = []; // etichete

	for(var i=0; i<img.pixels.length; i+=4) {
		var [r, g, b] = img.getRGB(i);

		if(!r || !b) {
			X.push([1, img.getx(i), img.gety(i)]);
			Y.push(r ? +1 : -1);
		}
	}

	var clasif = perceptron_online(X, Y);
	$('#iter_tot').text(clasif.iter);
	$('#errs_tot').text(clasif.totErrs);
	stopShow();
	showFrontiera(clasif.wLog, 0);
}

function perceptron_online(X, Y) {
	var w = [0.1, 0.1, 0.1];
	var wLog = [];
	var errs = 1;
	var iter;
	var totErrs = 0;

	var rates = [0, 1, 2].map(j => Number($('#rate' + j).val()));

	for(iter=0; iter<10000 && errs; iter++) {
		errs = 0;
		for(var i=0; i<X.length; i++) {
			var y = sgn(prod_scalar(w, X[i])); // predictie
			if(y * Y[i] < 0) { // semne diferite
				errs++;
				totErrs++;
				wLog.push({
					w: [w[0], w[1], w[2]],
					iter: iter+1,
					err: totErrs,
					point: {x: X[i][1], y: X[i][2]}
				});
				for(var j=0; j<3; j++) {
					w[j] += rates[j] * Y[i] * X[i][j];
				}
			}
		}
	}
	wLog.push({
		w: [w[0], w[1], w[2]],
		iter: iter,
		err: totErrs
	});

	console.log('DONE', iter, 'iterations', errs, 'errors.', 'w=', w);

	return {
		w: w,
		iter: iter,
		wLog: wLog,
		errs: errs,
		totErrs: totErrs
	};
}

var showFrontieraTimeout = null; // timeout id

function showFrontiera(wLog, k) {
	var w = wLog[k];
	if(!w) {
		return;
	}
	frontiera(w);
	showFrontieraTimeout = setTimeout(
		()=>showFrontiera(wLog, k+1),
		$('#timeout_ms').val()
	);
}

function stopShow() {
	clearTimeout(showFrontieraTimeout);
}

function frontiera(log) {
	var w = log.w;
	img.clear();
	img.drawLine(w[1], w[2], w[0]);
	if(log.point) {
		img.circle(log.point.x, log.point.y, 4);
	}

	draw_bar(0);
	draw_bar(1);
	draw_bar(2);

	function draw_bar(j) {
		var weight = w[j];
		$('#w'+j).width(Math.abs(100*weight)).css({
			left: weight < 0 ? 100*weight : 0
		}).text('w' + j + ' = ' + Math.round(weight * 1000) / 1000);
	}

	$('#iter_crt').text(log.iter);
	$('#err_crt').text(log.err);
}
</script>
</body>
</html>
